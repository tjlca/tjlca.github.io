

<!DOCTYPE html>
<html class="writer-html5" lang="Python" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>aegis &mdash; aegis 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=0ea5f55c"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            aegis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aegis.html">Aegis Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../statistical_analysis.html">Statistical analysis Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">aegis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">aegis</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for aegis</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">stewi</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">stewicombo</span>

<span class="c1"># Configure logging to output messages to stdout.</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">handlers</span><span class="o">=</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)]</span>
<span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="c1"># Set up result folder based on the current date.</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">result_folder</span> <span class="o">=</span> <span class="n">dt</span>
<span class="n">out_path1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_path1</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Results directory created or exists: </span><span class="si">{</span><span class="n">out_path1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating results directory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="save_data">
<a class="viewcode-back" href="../aegis.html#aegis.save_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_data</span><span class="p">(</span><span class="n">inventory</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves individual inventory information from STEWI.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inventory : str</span>
<span class="sd">        Inventory name (e.g., &#39;GHGRP&#39;, &#39;NEI&#39;, or &#39;TRI&#39;).</span>
<span class="sd">    year : int or str</span>
<span class="sd">        Year being analyzed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Running STEWI to get inventory by facility.</span>
        <span class="n">flow_by_facility</span> <span class="o">=</span> <span class="n">stewi</span><span class="o">.</span><span class="n">getInventory</span><span class="p">(</span><span class="n">inventory</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="s1">&#39;flowbyfacility&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;filter_for_LCI&#39;</span><span class="p">])</span>
        <span class="n">facility_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;flow_by_facility_</span><span class="si">{</span><span class="n">inventory</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
        <span class="n">flow_by_facility</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">facility_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved facility-level inventory for </span><span class="si">{</span><span class="n">inventory</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">facility_csv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error retrieving/saving facility-level inventory for </span><span class="si">{</span><span class="n">inventory</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Process level inventory may not be available for all databases.</span>
        <span class="n">flow_by_process</span> <span class="o">=</span> <span class="n">stewi</span><span class="o">.</span><span class="n">getInventory</span><span class="p">(</span><span class="n">inventory</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="s1">&#39;flowbyprocess&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;filter_for_LCI&#39;</span><span class="p">])</span>
        <span class="n">flow_by_process</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">year</span>
        <span class="n">process_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;flow_by_process_</span><span class="si">{</span><span class="n">inventory</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
        <span class="n">flow_by_process</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">process_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved process-level inventory for </span><span class="si">{</span><span class="n">inventory</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">process_csv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process-level data not available for </span><span class="si">{</span><span class="n">inventory</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">facility</span> <span class="o">=</span> <span class="n">stewi</span><span class="o">.</span><span class="n">getInventoryFacilities</span><span class="p">(</span><span class="n">inventory</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span>
        <span class="n">facility_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;facility_</span><span class="si">{</span><span class="n">inventory</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
        <span class="n">facility</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">facility_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved facility information for </span><span class="si">{</span><span class="n">inventory</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">facility_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error retrieving/saving facility information for </span><span class="si">{</span><span class="n">inventory</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="combine_facility_name_inv">
<a class="viewcode-back" href="../aegis.html#aegis.combine_facility_name_inv">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">combine_facility_name_inv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">out_path3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combines facility names from STEWI for debugging purposes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a, b, c : str</span>
<span class="sd">        Names of the inventories.</span>
<span class="sd">    out_path3 : str</span>
<span class="sd">        Path to the issue files directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;facility_</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">))</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;facility_</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">))</span>
        <span class="n">d3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;facility_</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">))</span>
        <span class="n">d4</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">])</span>
        <span class="n">combined_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;FacilityNamesFromStewicombined.csv&quot;</span><span class="p">)</span>
        <span class="n">d4</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">combined_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combined facility names saved to </span><span class="si">{</span><span class="n">combined_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error combining facility names: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="run_stewi">
<a class="viewcode-back" href="../aegis.html#aegis.run_stewi">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_stewi</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">out_path3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves combined inventory information from STEWI.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    option : str</span>
<span class="sd">        Inventory preference option.</span>
<span class="sd">    year : int or str</span>
<span class="sd">        Year being analyzed.</span>
<span class="sd">    out_path3 : str</span>
<span class="sd">        Path to the issue files directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">inv</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;GHGRP&#39;</span><span class="p">,</span> <span class="s1">&#39;NEI&#39;</span><span class="p">,</span> <span class="s1">&#39;TRI&#39;</span><span class="p">]:</span>
        <span class="n">save_data</span><span class="p">(</span><span class="n">inv</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span>
    
    <span class="n">inventory_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GHGRP&quot;</span><span class="p">:</span> <span class="n">year</span><span class="p">,</span> <span class="s2">&quot;NEI&quot;</span><span class="p">:</span> <span class="n">year</span><span class="p">,</span> <span class="s2">&quot;TRI&quot;</span><span class="p">:</span> <span class="n">year</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">option</span> <span class="o">!=</span> <span class="s2">&quot;GHGRP Preferred&quot;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Combining full inventories&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">stewicombo</span><span class="o">.</span><span class="n">combineFullInventories</span><span class="p">(</span><span class="n">inventory_dict</span><span class="p">,</span> <span class="n">filter_for_LCI</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_overlap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compartments</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using GHGRP as the preferred inventory&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">stewicombo</span><span class="o">.</span><span class="n">combineInventoriesforFacilitiesinBaseInventory</span><span class="p">(</span><span class="s2">&quot;GHGRP&quot;</span><span class="p">,</span> <span class="n">inventory_dict</span><span class="p">)</span>
        <span class="n">combined_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;combinedinventories_NEI_TRI_GHGRP.csv&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">combined_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combined inventories saved to </span><span class="si">{</span><span class="n">combined_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error combining inventories: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">combine_facility_name_inv</span><span class="p">(</span><span class="s1">&#39;NEI&#39;</span><span class="p">,</span> <span class="s1">&#39;TRI&#39;</span><span class="p">,</span> <span class="s1">&#39;GHGRP&#39;</span><span class="p">,</span> <span class="n">out_path3</span><span class="p">)</span></div>



<div class="viewcode-block" id="add_cas_number">
<a class="viewcode-back" href="../aegis.html#aegis.add_cas_number">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_cas_number</span><span class="p">(</span><span class="n">df_em</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assigns Chemical Abstracts Service (CAS) numbers to the emissions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_em : pandas.DataFrame</span>
<span class="sd">        Emissions inventory DataFrame.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        Emissions inventory with CAS numbers assigned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pollutants_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;pollutants_to_cas.csv&quot;</span><span class="p">))</span>
        <span class="n">df_em</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_em</span><span class="p">,</span> <span class="n">pollutants_all</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;FlowName&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CAS numbers successfully added to emissions data.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error adding CAS numbers: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_em</span></div>



<div class="viewcode-block" id="naics_code_checker">
<a class="viewcode-back" href="../aegis.html#aegis.naics_code_checker">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">naics_code_checker</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">frs_id_list</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">out_path3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks for NAICS code inconsistencies for facilities.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df1 : pandas.DataFrame</span>
<span class="sd">        DataFrame containing facility and emissions data.</span>
<span class="sd">    frs_id_list : list</span>
<span class="sd">        List of FRS IDs to check.</span>
<span class="sd">    sector : str</span>
<span class="sd">        Sector being analyzed.</span>
<span class="sd">    out_path3 : str</span>
<span class="sd">        Path to the issue files directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fac_with_naics_code_issue</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ide</span> <span class="ow">in</span> <span class="n">frs_id_list</span><span class="p">:</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ide</span><span class="p">]</span>
        <span class="n">naics_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;NAICS&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">naics_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityName&#39;</span><span class="p">,</span> <span class="s1">&#39;Address&#39;</span><span class="p">,</span> <span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;Zip&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;Latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;County&#39;</span><span class="p">,</span> <span class="s1">&#39;NAICS&#39;</span><span class="p">,</span> <span class="s1">&#39;SIC&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="n">fac_with_naics_code_issue</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">fac_with_naics_code_issue</span><span class="p">,</span> <span class="n">df2</span><span class="p">])</span>
    <span class="n">issues_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_facilities_with_naics_code_issues.csv&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fac_with_naics_code_issue</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">issues_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NAICS code issues saved to </span><span class="si">{</span><span class="n">issues_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving NAICS code issues file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="manipulate_databases">
<a class="viewcode-back" href="../aegis.html#aegis.manipulate_databases">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">manipulate_databases</span><span class="p">(</span><span class="n">naics_code1</span><span class="p">,</span> <span class="n">naics_code2</span><span class="p">,</span> <span class="n">naics_code3</span><span class="p">,</span> <span class="n">naics_code4</span><span class="p">,</span>
                         <span class="n">filename_flag</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">corrected_parquet_available_flag</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span>
                         <span class="n">ghgrpfilename</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">,</span> <span class="n">out_path3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads and manipulates combined inventories and facility data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    naics_code1, naics_code2, naics_code3, naics_code4 : int or str</span>
<span class="sd">        NAICS codes.</span>
<span class="sd">    filename_flag : bool</span>
<span class="sd">        Flag for Flight file availability.</span>
<span class="sd">    sector : str</span>
<span class="sd">        Industrial sector.</span>
<span class="sd">    corrected_parquet_available_flag : bool</span>
<span class="sd">        Flag for using corrected parquet.</span>
<span class="sd">    year : int or str</span>
<span class="sd">        Year being analyzed.</span>
<span class="sd">    ghgrpfilename : str</span>
<span class="sd">        Path to the GHGRP Flight file.</span>
<span class="sd">    out_path2 : str</span>
<span class="sd">        Path to the sector output directory.</span>
<span class="sd">    out_path3 : str</span>
<span class="sd">        Path to the issue files directory.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (df1_sector, naics_list, frs_id_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;combinedinventories_NEI_TRI_GHGRP.csv&quot;</span><span class="p">))</span>
        <span class="n">nei_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;facility_NEI.csv&quot;</span><span class="p">))</span>
        <span class="n">tri_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;facility_TRI.csv&quot;</span><span class="p">))</span>
        <span class="n">ghgrp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;facility_GHGRP.csv&quot;</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully loaded combined inventories and facility data.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading data files: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">combined_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;FlowName&#39;</span><span class="p">,</span> <span class="s1">&#39;Compartment&#39;</span><span class="p">,</span> <span class="s1">&#39;FlowAmount&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;DataReliability&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">,</span> <span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="s1">&#39;FRS_ID&#39;</span><span class="p">]]</span>
    <span class="n">combined_df</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>

    <span class="c1"># Tag facility data with their respective sources.</span>
    <span class="n">nei_df</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NEI&quot;</span>
    <span class="n">tri_df</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TRI&quot;</span>
    <span class="n">ghgrp_df</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GHGRP&quot;</span>

    <span class="n">df_facility</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ghgrp_df</span><span class="p">,</span> <span class="n">nei_df</span><span class="p">,</span> <span class="n">tri_df</span><span class="p">])</span>
    <span class="n">naics_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">df_facility</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_facility</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>

    <span class="c1"># Merge facility information with emissions inventory.</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_facility</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">],</span> <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="n">missing_in_flow</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;_merge&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;right_only&#39;</span><span class="p">]</span>
    <span class="n">missing_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="s2">&quot;missing_in_combined_flow_but_not_facility_level_inventory.csv&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">missing_in_flow</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">missing_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing flow data saved to </span><span class="si">{</span><span class="n">missing_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving missing flow data file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;_merge&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">]</span>

    <span class="c1"># Prepare facility-level DataFrame.</span>
    <span class="n">frs_fac_df</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;FRS_ID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[[</span><span class="s1">&#39;FlowName&#39;</span><span class="p">,</span> <span class="s1">&#39;Compartment&#39;</span><span class="p">,</span> <span class="s1">&#39;FlowAmount&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">,</span> <span class="s1">&#39;DataReliability&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">,</span> <span class="s1">&#39;Year&#39;</span><span class="p">,</span> 
               <span class="s1">&#39;FRS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityName&#39;</span><span class="p">,</span> <span class="s1">&#39;Address&#39;</span><span class="p">,</span> <span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;Zip&#39;</span><span class="p">,</span> <span class="s1">&#39;Latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Longitude&#39;</span><span class="p">,</span> 
               <span class="s1">&#39;County&#39;</span><span class="p">,</span> <span class="s1">&#39;NAICS&#39;</span><span class="p">,</span> <span class="s1">&#39;SIC&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">df_ghgrp</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GHGRP&quot;</span><span class="p">]</span>
    <span class="n">df_nei_tri</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NEI&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TRI&quot;</span><span class="p">)]</span>
    <span class="n">df1_air</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;Compartment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;air&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">filename_flag</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df_ghgrp_flight</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ghgrpfilename</span><span class="p">)</span>
            <span class="n">df_ghgrp_flight</span><span class="p">[</span><span class="s1">&#39;GHGRP ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ghgrp_flight</span><span class="p">[</span><span class="s1">&#39;GHGRP ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
            <span class="n">ghgrp_raw_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;GHGRP_epa_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.xlsx&quot;</span><span class="p">))</span>
            <span class="n">ghgrp_raw_data</span> <span class="o">=</span> <span class="n">ghgrp_raw_data</span><span class="p">[[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">,</span> <span class="s1">&#39;FRS Id&#39;</span><span class="p">,</span> <span class="s1">&#39;Facility Name&#39;</span><span class="p">,</span> <span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;Zip Code&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;Address&#39;</span><span class="p">,</span> <span class="s1">&#39;County&#39;</span><span class="p">,</span> <span class="s1">&#39;Latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Primary NAICS Code&#39;</span><span class="p">]]</span>
            <span class="n">ghgrp_raw_data</span><span class="p">[[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">,</span> <span class="s1">&#39;FRS Id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ghgrp_raw_data</span><span class="p">[[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">,</span> <span class="s1">&#39;FRS Id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
            <span class="n">df_ghgrp_flight</span> <span class="o">=</span> <span class="n">df_ghgrp_flight</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ghgrp_raw_data</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GHGRP ID&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">])</span>
            <span class="n">naics_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df_ghgrp_flight</span><span class="p">[</span><span class="s1">&#39;Primary NAICS Code&#39;</span><span class="p">]))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted NAICS list from GHGRP Flight file: </span><span class="si">{</span><span class="n">naics_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing GHGRP Flight file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">naics_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">df3</span> <span class="o">=</span> <span class="n">df_ghgrp</span><span class="p">[</span><span class="n">df_ghgrp</span><span class="p">[</span><span class="s1">&#39;NAICS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">naics_list</span><span class="p">)]</span>
        <span class="n">df4</span> <span class="o">=</span> <span class="n">df_nei_tri</span><span class="p">[</span><span class="n">df_nei_tri</span><span class="p">[</span><span class="s1">&#39;NAICS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">naics_list</span><span class="p">)]</span>
        <span class="n">df1_sector</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df3</span><span class="p">,</span> <span class="n">df4</span><span class="p">])</span>
        <span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">frs_id_list_2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]))</span>
        <span class="n">df1_air</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1_air</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">df1_sector</span> <span class="o">=</span> <span class="n">df1_air</span><span class="p">[</span><span class="n">df1_air</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">frs_id_list_2</span><span class="p">)]</span>
        <span class="n">naics_code_checker</span><span class="p">(</span><span class="n">df1_sector</span><span class="p">,</span> <span class="n">frs_id_list_2</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">out_path3</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fac_ids_from_ghgrp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df_ghgrp_flight</span><span class="p">[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">]))</span>
            <span class="n">df_ghgrp</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;FRS_ID&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_ghgrp</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;FRS_ID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
            <span class="n">ghgrp_chosen</span> <span class="o">=</span> <span class="n">df_ghgrp</span><span class="p">[</span><span class="n">df_ghgrp</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">fac_ids_from_ghgrp</span><span class="p">)]</span>
            <span class="n">frs_id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ghgrp_chosen</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing GHGRP facility IDs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">frs_id_list</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">df1_sector</span> <span class="o">=</span> <span class="n">add_cas_number</span><span class="p">(</span><span class="n">df1_sector</span><span class="p">)</span>
        <span class="n">sector_inventory_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_inventory_facility_level_including_all_facilities_from_all_db.csv&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df1_sector</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">sector_inventory_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sector facility-level inventory (all DB) saved to </span><span class="si">{</span><span class="n">sector_inventory_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving sector inventory file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">corrected_parquet_available_flag</span><span class="p">:</span>
            <span class="n">df1_sector</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="p">[</span><span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">frs_id_list</span><span class="p">)]</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_facility</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_facility</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_facility</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">],</span> <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">frs_fac_df</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;FRS_ID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[[</span><span class="s1">&#39;FlowName&#39;</span><span class="p">,</span> <span class="s1">&#39;Compartment&#39;</span><span class="p">,</span> <span class="s1">&#39;FlowAmount&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">,</span> <span class="s1">&#39;DataReliability&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">,</span> <span class="s1">&#39;Year&#39;</span><span class="p">,</span> 
                   <span class="s1">&#39;FRS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityName&#39;</span><span class="p">,</span> <span class="s1">&#39;Address&#39;</span><span class="p">,</span> <span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;Zip&#39;</span><span class="p">,</span> <span class="s1">&#39;Latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Longitude&#39;</span><span class="p">,</span> 
                   <span class="s1">&#39;County&#39;</span><span class="p">,</span> <span class="s1">&#39;NAICS&#39;</span><span class="p">,</span> <span class="s1">&#39;SIC&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">df1_air</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;Compartment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;air&quot;</span><span class="p">]</span>
        <span class="n">df1_air</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1_air</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">df1_sector</span> <span class="o">=</span> <span class="n">df1_air</span><span class="p">[(</span><span class="n">df1_air</span><span class="p">[</span><span class="s1">&#39;NAICS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">naics_code1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df1_air</span><span class="p">[</span><span class="s1">&#39;NAICS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">naics_code2</span><span class="p">)]</span>
        <span class="n">frs_id_list_all_db</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]))</span>
        <span class="n">df1_sector</span> <span class="o">=</span> <span class="n">df1_air</span><span class="p">[</span><span class="n">df1_air</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">frs_id_list_all_db</span><span class="p">)]</span>
        <span class="n">naics_code_checker</span><span class="p">(</span><span class="n">df1_sector</span><span class="p">,</span> <span class="n">frs_id_list_all_db</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">out_path3</span><span class="p">)</span>
    
        <span class="n">df_ghgrp</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="p">[</span><span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GHGRP&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">df_ghgrp</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ghgrp</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">frs_id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df_ghgrp</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]))</span>
        <span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">corrected_parquet_available_flag</span><span class="p">:</span>
            <span class="n">df1_sector</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="p">[</span><span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">frs_id_list</span><span class="p">)]</span>
    
    <span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
    <span class="n">df1_sector</span> <span class="o">=</span> <span class="n">add_cas_number</span><span class="p">(</span><span class="n">df1_sector</span><span class="p">)</span>
    <span class="n">final_inventory_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_inventory_facility_level.csv&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df1_sector</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">final_inventory_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final sector facility-level inventory saved to </span><span class="si">{</span><span class="n">final_inventory_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving final sector inventory file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df1_sector</span><span class="p">,</span> <span class="n">naics_list</span><span class="p">,</span> <span class="n">frs_id_list</span></div>



<div class="viewcode-block" id="facility_stack_parameters">
<a class="viewcode-back" href="../aegis.html#aegis.facility_stack_parameters">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">facility_stack_parameters</span><span class="p">(</span><span class="n">df1_sector</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combines facility information with available stack parameters from the NEI database.</span>
<span class="sd">    Facilities not reporting to the NEI database do not have any stack data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df1_sector : pandas.DataFrame</span>
<span class="sd">        DataFrame containing facility-level inventory data.</span>
<span class="sd">    sector : str</span>
<span class="sd">        The sector name.</span>
<span class="sd">    out_path2 : str</span>
<span class="sd">        Path to the output directory for the sector.</span>

<span class="sd">    Outputs</span>
<span class="sd">    -------</span>
<span class="sd">    Writes CSV files with stack parameter information for available facilities.</span>
<span class="sd">    The output file contains columns for emissions, facility ID, facility name, and stack data.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Read the NEI stack parameter data file.</span>
        <span class="n">nei_flat_file</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;reduced_stack_file.csv&quot;</span><span class="p">),</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">nei_flat_file</span><span class="p">[</span><span class="s1">&#39;FACILITY_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nei_flat_file</span><span class="p">[</span><span class="s1">&#39;FACILITY_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">nei_flat_file</span> <span class="o">=</span> <span class="n">nei_flat_file</span><span class="p">[[</span><span class="s1">&#39;FACILITY_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;UNIT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;PROCESS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;STKHGT&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;STKDIAM&#39;</span><span class="p">,</span> <span class="s1">&#39;STKTEMP&#39;</span><span class="p">,</span> <span class="s1">&#39;STKFLOW&#39;</span><span class="p">,</span> <span class="s1">&#39;STKVEL&#39;</span><span class="p">]]</span>
        <span class="n">df_inv</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_inv</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_inv</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">nei_flat_file_cem</span> <span class="o">=</span> <span class="n">df_inv</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">nei_flat_file</span><span class="p">,</span>
                                         <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">],</span>
                                         <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FACILITY_ID&#39;</span><span class="p">])</span>
        <span class="n">nei_flat_file_cem</span><span class="p">[</span><span class="s1">&#39;FACILITY_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nei_flat_file_cem</span><span class="p">[</span><span class="s1">&#39;FACILITY_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">nei_flat_file_cem</span><span class="p">[</span><span class="s1">&#39;PROCESS_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nei_flat_file_cem</span><span class="p">[</span><span class="s1">&#39;PROCESS_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">nei_flat_file_cem</span><span class="p">[</span><span class="s1">&#39;STKFLOW&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">nei_flat_file_cem</span><span class="p">[</span><span class="s1">&#39;STKFLOW&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

        <span class="c1"># Read facility information from NEI.</span>
        <span class="n">facility_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;facility_NEI.csv&quot;</span><span class="p">))</span>
        <span class="n">facility_info</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">facility_info</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>

        <span class="c1"># Create and save flat facility file with stack parameters.</span>
        <span class="n">flat_fac</span> <span class="o">=</span> <span class="n">nei_flat_file_cem</span><span class="p">[[</span><span class="s1">&#39;FACILITY_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;STKHGT&#39;</span><span class="p">,</span> <span class="s1">&#39;STKDIAM&#39;</span><span class="p">,</span> <span class="s1">&#39;STKTEMP&#39;</span><span class="p">,</span> <span class="s1">&#39;STKFLOW&#39;</span><span class="p">,</span> <span class="s1">&#39;STKVEL&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">flat_fac</span> <span class="o">=</span> <span class="n">flat_fac</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">facility_info</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FACILITY_ID&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">])</span>
        <span class="n">stack_file_fac</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_nei_fac_level_info_for_stack_parameters.csv&quot;</span><span class="p">)</span>
        <span class="n">flat_fac</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">stack_file_fac</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NEI facility-level stack parameters saved to </span><span class="si">{</span><span class="n">stack_file_fac</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create and save flat unit file with stack parameters.</span>
        <span class="n">flat_unit</span> <span class="o">=</span> <span class="n">nei_flat_file_cem</span><span class="p">[[</span><span class="s1">&#39;FACILITY_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;STKHGT&#39;</span><span class="p">,</span> <span class="s1">&#39;STKDIAM&#39;</span><span class="p">,</span> <span class="s1">&#39;STKTEMP&#39;</span><span class="p">,</span> <span class="s1">&#39;STKFLOW&#39;</span><span class="p">,</span> <span class="s1">&#39;STKVEL&#39;</span><span class="p">,</span> <span class="s1">&#39;UNIT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;PROCESS_ID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">nei_flow_by_process</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;flow_by_process_NEI.csv&quot;</span><span class="p">))</span>
        <span class="n">nei_flow_by_process</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nei_flow_by_process</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">nei_flow_by_process</span><span class="p">[</span><span class="s1">&#39;Process&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">nei_flow_by_process</span><span class="p">[</span><span class="s1">&#39;Process&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
        <span class="n">flat_unit</span> <span class="o">=</span> <span class="n">flat_unit</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">facility_info</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FACILITY_ID&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">])</span>
        <span class="n">stack_file_unit</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_nei_unit_level_info_for_stack_parameters.csv&quot;</span><span class="p">)</span>
        <span class="n">flat_unit</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">stack_file_unit</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NEI unit-level stack parameters saved to </span><span class="si">{</span><span class="n">stack_file_unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;File not found: reduced_stack_file.csv &gt; 300 MB. Please ask authors for the file to create inventory with stack parameters. Error: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></div>



<div class="viewcode-block" id="overlap_explorer">
<a class="viewcode-back" href="../aegis.html#aegis.overlap_explorer">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">overlap_explorer</span><span class="p">(</span><span class="n">df1_sector</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">out_path3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Explores overlap between databases and facilities by identifying the number of databases</span>
<span class="sd">    that report for each facility (or FRS ID) and listing the associated emission flows.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df1_sector : pandas.DataFrame</span>
<span class="sd">        DataFrame containing facility-level emissions data.</span>
<span class="sd">    sector : str</span>
<span class="sd">        The sector name.</span>
<span class="sd">    out_path3 : str</span>
<span class="sd">        Path to the issue files directory.</span>

<span class="sd">    Outputs</span>
<span class="sd">    -------</span>
<span class="sd">    Writes CSV files with:</span>
<span class="sd">      - Overlap information with facility names.</span>
<span class="sd">      - Overlap information without facility names (to reduce duplicates).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">frs_id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]))</span>
        <span class="n">frs_id_df</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="p">[[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">,</span> <span class="s1">&#39;FlowName&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">name_df</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="p">[[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityName&#39;</span><span class="p">,</span> <span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;Latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Longitude&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

        <span class="n">source_list_all</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">frs_a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">flows_all</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">co2_missing_flags</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">frs</span> <span class="ow">in</span> <span class="n">frs_id_list</span><span class="p">:</span>
            <span class="n">chk</span> <span class="o">=</span> <span class="n">frs_id_df</span><span class="p">[</span><span class="n">frs_id_df</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">frs</span><span class="p">]</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">chk</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">])))</span>
            <span class="n">flows</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">chk</span><span class="p">[</span><span class="s1">&#39;FlowName&#39;</span><span class="p">])))</span>
            <span class="n">source_list_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources</span><span class="p">))</span>
            <span class="n">flows_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flows</span><span class="p">)</span>
            <span class="c1"># Flag as True if &quot;Carbon Dioxide&quot; is missing from the flow list.</span>
            <span class="n">co2_missing_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Carbon Dioxide&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flows</span><span class="p">)</span>
            <span class="n">frs_a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frs</span><span class="p">)</span>

        <span class="n">overlap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;FRS_ID&#39;</span><span class="p">:</span> <span class="n">frs_a</span><span class="p">,</span>
            <span class="s1">&#39;Source&#39;</span><span class="p">:</span> <span class="n">source_list_all</span><span class="p">,</span>
            <span class="s1">&#39;Flows&#39;</span><span class="p">:</span> <span class="n">flows_all</span><span class="p">,</span>
            <span class="s1">&#39;CO2 missing&#39;</span><span class="p">:</span> <span class="n">co2_missing_flags</span>
        <span class="p">})</span>
        <span class="n">overlap_df</span> <span class="o">=</span> <span class="n">overlap_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">name_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">)</span>
        <span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;City&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;City&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;City&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">overlap_df</span> <span class="o">=</span> <span class="n">overlap_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;city&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>

        <span class="n">overlap_file_with_names</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_overlap_explorer_with_facility_names.csv&quot;</span><span class="p">)</span>
        <span class="n">overlap_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">overlap_file_with_names</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overlap explorer file (with facility names) saved to </span><span class="si">{</span><span class="n">overlap_file_with_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">overlap_df_corr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">cities</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">])))</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cities</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">overlap_df</span><span class="p">[</span><span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sources_names</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="c1"># Remove duplicates while preserving order.</span>
                <span class="n">sources_names_1</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sources_names</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">sources_names</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
                <span class="c1"># If only NEI and TRI are reported, then skip.</span>
                <span class="k">if</span> <span class="n">sources_names_1</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;NEI&quot;</span><span class="p">,</span> <span class="s2">&quot;TRI&quot;</span><span class="p">,</span> <span class="s2">&quot;NEI TRI&quot;</span><span class="p">,</span> <span class="s2">&quot;TRI NEI&quot;</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">overlap_df_corr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">overlap_df_corr</span><span class="p">,</span> <span class="n">d</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">overlap_df_corr</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">overlap_file_corr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_overlap_explorer_with_facility_names.csv&quot;</span><span class="p">)</span>
            <span class="n">overlap_df_corr</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">overlap_file_corr</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overlap explorer corrected file saved to </span><span class="si">{</span><span class="n">overlap_file_corr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Drop facility names to avoid duplicates.</span>
            <span class="k">if</span> <span class="s1">&#39;FacilityName&#39;</span> <span class="ow">in</span> <span class="n">overlap_df_corr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">overlap_df_corr</span> <span class="o">=</span> <span class="n">overlap_df_corr</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FacilityName&#39;</span><span class="p">])</span>
            <span class="n">overlap_file_no_names</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_overlap_explorer_without_facility_names.csv&quot;</span><span class="p">)</span>
            <span class="n">overlap_df_corr</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">overlap_file_no_names</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overlap explorer file (without facility names) saved to </span><span class="si">{</span><span class="n">overlap_file_no_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error during overlap exploration: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></div>



<div class="viewcode-block" id="emission_concentration_calculation">
<a class="viewcode-back" href="../aegis.html#aegis.emission_concentration_calculation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">emission_concentration_calculation</span><span class="p">(</span><span class="n">df1_sector</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates emission concentration by summing up all reported emissions per facility and then computing</span>
<span class="sd">    the concentration of each individual emission relative to the total. It further extracts facilities that</span>
<span class="sd">    report CO2 and focuses analysis on those facilities.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df1_sector : pandas.DataFrame</span>
<span class="sd">        DataFrame of sector facilities with emission data.</span>
<span class="sd">    sector : str</span>
<span class="sd">        The sector name.</span>
<span class="sd">    out_path2 : str</span>
<span class="sd">        Path to the sector output directory.</span>

<span class="sd">    Outputs</span>
<span class="sd">    -------</span>
<span class="sd">    Writes CSV file with concentration calculations for facility-level emissions, including CO2 flows.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        DataFrame of sector facilities that report CO2 emissions along with all other emissions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">co2_df</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="p">[</span><span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;FlowName&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Carbon Dioxide&quot;</span><span class="p">]</span>
        <span class="n">sector_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]))</span>
        <span class="n">sector_df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">fid</span> <span class="ow">in</span> <span class="n">sector_ids</span><span class="p">:</span>
            <span class="n">df_fac</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="p">[</span><span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fid</span><span class="p">]</span>
            <span class="n">total_flow</span> <span class="o">=</span> <span class="n">df_fac</span><span class="p">[</span><span class="s1">&#39;FlowAmount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">df_fac</span> <span class="o">=</span> <span class="n">df_fac</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df_fac</span><span class="p">[</span><span class="s1">&#39;FlowSum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_flow</span>
            <span class="n">df_fac</span><span class="p">[</span><span class="s1">&#39;Concentration kg/kg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_fac</span><span class="p">[</span><span class="s1">&#39;FlowAmount&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_flow</span> <span class="k">if</span> <span class="n">total_flow</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">sector_df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">sector_df1</span><span class="p">,</span> <span class="n">df_fac</span><span class="p">])</span>
        
        <span class="n">sector_df1</span> <span class="o">=</span> <span class="n">sector_df1</span><span class="p">[[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;FlowName&#39;</span><span class="p">,</span> <span class="s1">&#39;Compartment&#39;</span><span class="p">,</span> <span class="s1">&#39;FlowAmount&#39;</span><span class="p">,</span> <span class="s1">&#39;FlowSum&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;Concentration kg/kg&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">,</span> <span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityName&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;Latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;County&#39;</span><span class="p">,</span> <span class="s1">&#39;NAICS&#39;</span><span class="p">,</span> <span class="s1">&#39;SIC&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityID&#39;</span><span class="p">]]</span>
        <span class="c1"># Filter to include only facilities that report CO2.</span>
        <span class="n">sector_facilities_with_co2</span> <span class="o">=</span> <span class="n">sector_df1</span><span class="p">[</span><span class="n">sector_df1</span><span class="p">[</span><span class="s1">&#39;FlowName&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Carbon Dioxide&#39;</span><span class="p">][[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">sector_df2</span> <span class="o">=</span> <span class="n">sector_df1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sector_facilities_with_co2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">)</span>
        <span class="n">sector_df3</span> <span class="o">=</span> <span class="n">sector_df2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Keeping a copy for further use.</span>
        <span class="n">sector_df3</span> <span class="o">=</span> <span class="n">add_cas_number</span><span class="p">(</span><span class="n">sector_df3</span><span class="p">)</span>
        <span class="n">final_inventory_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_inventory_facility_level_emissions_with_co2_conc_calculated.csv&quot;</span><span class="p">)</span>
        <span class="n">sector_df3</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">final_inventory_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Emission concentration calculations saved to </span><span class="si">{</span><span class="n">final_inventory_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sector_df2</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error during emission concentration calculation: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="plots_and_exploration1">
<a class="viewcode-back" href="../aegis.html#aegis.plots_and_exploration1">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plots_and_exploration1</span><span class="p">(</span><span class="n">sector_df2</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates exploratory plots for specified cap emissions by visualizing concentration and flow amount.</span>
<span class="sd">    Saves scatter plots for each emission type and outputs a CSV file containing facility-level data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sector_df2 : pandas.DataFrame</span>
<span class="sd">        DataFrame for sector facilities with CO2 emission data.</span>
<span class="sd">    sector : str</span>
<span class="sd">        The sector name.</span>
<span class="sd">    out_path2 : str</span>
<span class="sd">        Path to the sector output directory.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cap_emissions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Carbon Dioxide&#39;</span><span class="p">,</span> <span class="s1">&#39;Methane&#39;</span><span class="p">,</span> <span class="s1">&#39;Nitrogen Oxides&#39;</span><span class="p">,</span> <span class="s1">&#39;Nitrous Oxide&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;Sulfur Dioxide&#39;</span><span class="p">,</span> <span class="s1">&#39;Volatile Organic Compounds&#39;</span><span class="p">,</span> <span class="s1">&#39;PM10-PM2.5&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;PM2.5 Primary (Filt + Cond)&#39;</span><span class="p">]</span>
        <span class="n">sector_inv_for_cap_em</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">em</span> <span class="ow">in</span> <span class="n">cap_emissions</span><span class="p">:</span>
            <span class="n">em_df</span> <span class="o">=</span> <span class="n">sector_df2</span><span class="p">[</span><span class="n">sector_df2</span><span class="p">[</span><span class="s1">&#39;FlowName&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">em</span><span class="p">]</span>
            <span class="n">sector_inv_for_cap_em</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">sector_inv_for_cap_em</span><span class="p">,</span> <span class="n">em_df</span><span class="p">])</span>
            <span class="c1"># Plot concentration scatter plot.</span>
            <span class="n">fig1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">em_df</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">em_df</span><span class="p">[</span><span class="s1">&#39;Concentration kg/kg&#39;</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">em</span><span class="si">}</span><span class="s2">_concentration_kg/kg&quot;</span><span class="p">)</span>
            <span class="n">plot_file1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">em</span><span class="si">}</span><span class="s2">_concentrationkgperkg.png&quot;</span><span class="p">)</span>
            <span class="n">fig1</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_file1</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig1</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved plot: </span><span class="si">{</span><span class="n">plot_file1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Plot flow amount scatter plot.</span>
            <span class="n">fig2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">em_df</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">em_df</span><span class="p">[</span><span class="s1">&#39;FlowAmount&#39;</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">em</span><span class="si">}</span><span class="s2">_flowamount&quot;</span><span class="p">)</span>
            <span class="n">plot_file2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">em</span><span class="si">}</span><span class="s2">_flowamount.png&quot;</span><span class="p">)</span>
            <span class="n">fig2</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_file2</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig2</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved plot: </span><span class="si">{</span><span class="n">plot_file2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">cap_emissions_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_facility_level_cap_emissions.csv&quot;</span><span class="p">)</span>
        <span class="n">sector_inv_for_cap_em</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">cap_emissions_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cap emissions data saved to </span><span class="si">{</span><span class="n">cap_emissions_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in plots_and_exploration1: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></div>



<div class="viewcode-block" id="concentration_calculation">
<a class="viewcode-back" href="../aegis.html#aegis.concentration_calculation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">concentration_calculation</span><span class="p">(</span><span class="n">df1_sector</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">,</span> <span class="n">co2concentration</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the concentration of emissions based on a CO2 reference.</span>
<span class="sd">    It first isolates the CO2 flow for each facility, computes total emissions excluding CO2,</span>
<span class="sd">    then calculates the total flue gas amount. Finally, it computes the concentration of each emission.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df1_sector : pandas.DataFrame</span>
<span class="sd">        DataFrame containing flow emissions data.</span>
<span class="sd">    sector : str</span>
<span class="sd">        The sector name.</span>
<span class="sd">    out_path2 : str</span>
<span class="sd">        Path to the sector output directory.</span>
<span class="sd">    co2concentration : float</span>
<span class="sd">        The literature-obtained CO2 concentration value for the sector.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Extract CO2 data.</span>
        <span class="n">data_co2_only</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df1_sector</span><span class="p">[</span><span class="s2">&quot;FlowName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Carbon Dioxide&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;FRS_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;FlowAmount&quot;</span><span class="p">,</span> <span class="s2">&quot;Source&quot;</span><span class="p">]]</span>
        <span class="n">data_co2_only</span> <span class="o">=</span> <span class="n">data_co2_only</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;FlowAmount&quot;</span><span class="p">:</span> <span class="s2">&quot;CO2Amount&quot;</span><span class="p">,</span> <span class="s2">&quot;Source&quot;</span><span class="p">:</span> <span class="s2">&quot;CO2Source&quot;</span><span class="p">})</span>

        <span class="c1"># Total emissions minus CO2.</span>
        <span class="n">data_all_emissions_minus_CO2</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df1_sector</span><span class="p">[</span><span class="s2">&quot;FlowName&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Carbon Dioxide&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;FRS_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;FlowAmount&quot;</span><span class="p">]]</span>
        <span class="n">data_all_emissions_minus_CO2</span> <span class="o">=</span> <span class="n">data_all_emissions_minus_CO2</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;FlowAmount&quot;</span><span class="p">:</span> <span class="s2">&quot;TotalFlowAmountminusCO2&quot;</span><span class="p">})</span>
        <span class="n">data_sum_all_emissions_minus_CO2</span> <span class="o">=</span> <span class="n">data_all_emissions_minus_CO2</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;FRS_ID&quot;</span><span class="p">)[</span><span class="s2">&quot;TotalFlowAmountminusCO2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># Merge CO2 and non-CO2 data with the main DataFrame.</span>
        <span class="n">df1_sector</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df1_sector</span><span class="p">,</span> <span class="n">data_co2_only</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;FRS_ID&quot;</span><span class="p">)</span>
        <span class="n">df1_sector</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df1_sector</span><span class="p">,</span> <span class="n">data_sum_all_emissions_minus_CO2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;FRS_ID&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate total flue gas using the provided CO2 concentration.</span>
        <span class="n">df1_sector</span><span class="p">[</span><span class="s2">&quot;Total_Flue_Gas_Amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="p">[</span><span class="s2">&quot;CO2Amount&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">co2concentration</span> <span class="o">+</span> <span class="n">df1_sector</span><span class="p">[</span><span class="s2">&quot;TotalFlowAmountminusCO2&quot;</span><span class="p">]</span>
        <span class="n">df1_sector</span><span class="p">[</span><span class="s2">&quot;Concentration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="p">[</span><span class="s2">&quot;FlowAmount&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df1_sector</span><span class="p">[</span><span class="s2">&quot;Total_Flue_Gas_Amount&quot;</span><span class="p">]</span>

        <span class="n">df1_sector</span> <span class="o">=</span> <span class="n">add_cas_number</span><span class="p">(</span><span class="n">df1_sector</span><span class="p">)</span>
        <span class="n">concentration_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_facility_level_with_concentration_via_co2_reference.csv&quot;</span><span class="p">)</span>
        <span class="n">df1_sector</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">concentration_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Concentration calculation results saved to </span><span class="si">{</span><span class="n">concentration_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df1_sector</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error during concentration calculation: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></div>



<div class="viewcode-block" id="plots_and_exploration2">
<a class="viewcode-back" href="../aegis.html#aegis.plots_and_exploration2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plots_and_exploration2</span><span class="p">(</span><span class="n">sector_df3</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates exploratory plots for back-calculated emission concentrations.</span>
<span class="sd">    It uses a literature-based CO2 concentration reference to back-calculate the total flue gas amount,</span>
<span class="sd">    and then recalculates pollutant concentrations for each facility.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sector_df3 : pandas.DataFrame</span>
<span class="sd">        DataFrame for sector facilities with back-calculated emission concentration data.</span>
<span class="sd">    sector : str</span>
<span class="sd">        The sector name.</span>
<span class="sd">    out_path2 : str</span>
<span class="sd">        Path to the sector output directory.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cap_emissions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Carbon Dioxide&#39;</span><span class="p">,</span> <span class="s1">&#39;Methane&#39;</span><span class="p">,</span> <span class="s1">&#39;Nitrogen Oxides&#39;</span><span class="p">,</span> <span class="s1">&#39;Nitrous Oxide&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;Sulfur Dioxide&#39;</span><span class="p">,</span> <span class="s1">&#39;Volatile Organic Compounds&#39;</span><span class="p">,</span> <span class="s1">&#39;PM10-PM2.5&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;PM2.5 Primary (Filt + Cond)&#39;</span><span class="p">]</span>
        <span class="n">sector_inv_for_cap_em</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">em</span> <span class="ow">in</span> <span class="n">cap_emissions</span><span class="p">:</span>
            <span class="n">em_df</span> <span class="o">=</span> <span class="n">sector_df3</span><span class="p">[</span><span class="n">sector_df3</span><span class="p">[</span><span class="s1">&#39;FlowName&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">em</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;For emission </span><span class="si">%s</span><span class="s2">, total number of facilities obtained is </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">em</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">em_df</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
            <span class="n">sector_inv_for_cap_em</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">sector_inv_for_cap_em</span><span class="p">,</span> <span class="n">em_df</span><span class="p">])</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">em_df</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">em_df</span><span class="p">[</span><span class="s1">&#39;Concentration&#39;</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">em</span><span class="si">}</span><span class="s2">_concentration_kg/kg&quot;</span><span class="p">)</span>
            <span class="n">plot_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">em</span><span class="si">}</span><span class="s2">_concentrationkgperkg_backcalculated.png&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved plot: </span><span class="si">{</span><span class="n">plot_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">backcalc_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_facility_level_cap_emissions_backcalculated.csv&quot;</span><span class="p">)</span>
        <span class="n">sector_inv_for_cap_em</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">backcalc_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Back-calculated cap emissions data saved to </span><span class="si">{</span><span class="n">backcalc_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in plots_and_exploration2: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="nei_by_process_exploration">
<a class="viewcode-back" href="../aegis.html#aegis.nei_by_process_exploration">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">nei_by_process_exploration</span><span class="p">(</span><span class="n">naics1</span><span class="p">,</span> <span class="n">naics2</span><span class="p">,</span> <span class="n">naics3</span><span class="p">,</span> <span class="n">naics4</span><span class="p">,</span>
                               <span class="n">filename_flag</span><span class="p">,</span> <span class="n">naics_list</span><span class="p">,</span> <span class="n">corrected_parquet_available_flag</span><span class="p">,</span>
                               <span class="n">frs_id_list</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">,</span> <span class="n">sector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Explores the NEI dataset by process emissions from STEWI. Combines the SCC codes with NEI provided codes</span>
<span class="sd">    and obtains fuel and unit information.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    naics1, naics2, naics3, naics4 : int or str</span>
<span class="sd">        Various NAICS codes.</span>
<span class="sd">    filename_flag : bool</span>
<span class="sd">        Flag indicating if the GHGRP Flight file is available.</span>
<span class="sd">    naics_list : list</span>
<span class="sd">        List of NAICS codes extracted (if available) from the Flight file.</span>
<span class="sd">    corrected_parquet_available_flag : bool</span>
<span class="sd">        Flag indicating if a corrected parquet file is available.</span>
<span class="sd">    frs_id_list : list</span>
<span class="sd">        List of FRS IDs used for filtering.</span>
<span class="sd">    out_path2 : str</span>
<span class="sd">        Output directory for the sector.</span>
<span class="sd">    sector : str</span>
<span class="sd">        The sector name.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">flow_by_process</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;flow_by_process_NEI.csv&quot;</span><span class="p">))</span>
        <span class="n">flow_by_process</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NEI&quot;</span>

        <span class="n">nei_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;facility_NEI.csv&quot;</span><span class="p">))</span>
        <span class="n">tri_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;facility_TRI.csv&quot;</span><span class="p">))</span>
        <span class="n">ghgrp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;facility_GHGRP.csv&quot;</span><span class="p">))</span>

        <span class="n">nei_df</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NEI&quot;</span>
        <span class="n">tri_df</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TRI&quot;</span>
        <span class="n">ghgrp_df</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GHGRP&quot;</span>

        <span class="c1"># Combine facility data from different inventories.</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ghgrp_df</span><span class="p">,</span> <span class="n">nei_df</span><span class="p">,</span> <span class="n">tri_df</span><span class="p">])</span>

        <span class="c1"># Convert FacilityID and Source to strings.</span>
        <span class="n">flow_by_process</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">flow_by_process</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">df2</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>

        <span class="c1"># Merge flow data with facility data.</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">flow_by_process</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

        <span class="c1"># Select relevant columns.</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;FlowName&#39;</span><span class="p">,</span> <span class="s1">&#39;Compartment&#39;</span><span class="p">,</span> <span class="s1">&#39;FlowAmount&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;DataReliability&#39;</span><span class="p">,</span> <span class="s1">&#39;Process&#39;</span><span class="p">,</span> <span class="s1">&#39;ProcessType&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityName&#39;</span><span class="p">,</span> <span class="s1">&#39;Address&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;Zip&#39;</span><span class="p">,</span> <span class="s1">&#39;Latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;County&#39;</span><span class="p">,</span> <span class="s1">&#39;NAICS&#39;</span><span class="p">,</span> <span class="s1">&#39;SIC&#39;</span><span class="p">]]</span>

        <span class="c1"># Keep only air emissions.</span>
        <span class="n">df1_air</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;Compartment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;air&quot;</span><span class="p">]</span>

        <span class="c1"># Filter by NAICS codes.</span>
        <span class="k">if</span> <span class="n">filename_flag</span><span class="p">:</span>
            <span class="n">df1_sector</span> <span class="o">=</span> <span class="n">df1_air</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df1_air</span><span class="p">[</span><span class="s1">&#39;NAICS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">naics_list</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df1_sector</span> <span class="o">=</span> <span class="n">df1_air</span><span class="p">[(</span><span class="n">df1_air</span><span class="p">[</span><span class="s1">&#39;NAICS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">naics1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df1_air</span><span class="p">[</span><span class="s1">&#39;NAICS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">naics2</span><span class="p">)</span> <span class="o">|</span>
                                 <span class="p">(</span><span class="n">df1_air</span><span class="p">[</span><span class="s1">&#39;NAICS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">naics3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df1_air</span><span class="p">[</span><span class="s1">&#39;NAICS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">naics4</span><span class="p">)]</span>

        <span class="c1"># Merge with SCC map to obtain additional process information.</span>
        <span class="n">scc_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;SCCmap.csv&quot;</span><span class="p">))</span>
        <span class="n">scc_map</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scc_map</span><span class="p">[</span><span class="s1">&#39;SCC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;Process&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;Process&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">df1_sector_process</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">scc_map</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Process&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SCC&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

        <span class="n">df1_sector_process</span> <span class="o">=</span> <span class="n">df1_sector_process</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;FlowName&#39;</span><span class="p">,</span> <span class="s1">&#39;Compartment&#39;</span><span class="p">,</span> <span class="s1">&#39;FlowAmount&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;DataReliability&#39;</span><span class="p">,</span> <span class="s1">&#39;Process&#39;</span><span class="p">,</span> <span class="s1">&#39;ProcessType&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityName&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;Address&#39;</span><span class="p">,</span> <span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;Zip&#39;</span><span class="p">,</span> <span class="s1">&#39;Latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Longitude&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;County&#39;</span><span class="p">,</span> <span class="s1">&#39;NAICS&#39;</span><span class="p">,</span> <span class="s1">&#39;SIC&#39;</span><span class="p">,</span> <span class="s1">&#39;SCC&#39;</span><span class="p">,</span> <span class="s1">&#39;code description&#39;</span><span class="p">,</span> <span class="s1">&#39;data category&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;scc level one&#39;</span><span class="p">,</span> <span class="s1">&#39;scc level two&#39;</span><span class="p">,</span> <span class="s1">&#39;scc level three&#39;</span><span class="p">,</span> <span class="s1">&#39;scc level four&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;short name&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;tier 1 code&#39;</span><span class="p">,</span> <span class="s1">&#39;tier 1 description&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;tier 2 code&#39;</span><span class="p">,</span> <span class="s1">&#39;tier 2 description&#39;</span><span class="p">,</span> <span class="s1">&#39;tier 3 code&#39;</span><span class="p">,</span> <span class="s1">&#39;tier 3 description&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

        <span class="c1"># Merge with FRS ID from the combined inventories.</span>
        <span class="n">frs_id_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;combinedinventories_NEI_TRI_GHGRP.csv&quot;</span><span class="p">))</span>
        <span class="n">frs_id_df</span> <span class="o">=</span> <span class="n">frs_id_df</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;FRS_ID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">frs_id_df</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;FRS_ID&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">frs_id_df</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;FRS_ID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">df1_sector_process</span> <span class="o">=</span> <span class="n">df1_sector_process</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">frs_id_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

        <span class="c1"># Ensure FRS IDs are strings.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frs_id_list</span><span class="p">)):</span>
            <span class="n">frs_id_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">frs_id_list</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">corrected_parquet_available_flag</span><span class="p">:</span>
            <span class="n">df1_sector_process</span> <span class="o">=</span> <span class="n">df1_sector_process</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df1_sector_process</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">frs_id_list</span><span class="p">)]</span>

        <span class="n">df1_sector_process</span> <span class="o">=</span> <span class="n">df1_sector_process</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">df1_sector_process</span> <span class="o">=</span> <span class="n">add_cas_number</span><span class="p">(</span><span class="n">df1_sector_process</span><span class="p">)</span>

        <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_inventory_with_process_data_nei.csv&quot;</span><span class="p">)</span>
        <span class="n">df1_sector_process</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NEI process data exploration saved to </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in nei_by_process_exploration: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></div>



<div class="viewcode-block" id="ghgrp_process_exploration_unit">
<a class="viewcode-back" href="../aegis.html#aegis.ghgrp_process_exploration_unit">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ghgrp_process_exploration_unit</span><span class="p">(</span><span class="n">naics1</span><span class="p">,</span> <span class="n">naics2</span><span class="p">,</span> <span class="n">naics3</span><span class="p">,</span> <span class="n">naics4</span><span class="p">,</span>
                                   <span class="n">filename_flag</span><span class="p">,</span> <span class="n">naics_list</span><span class="p">,</span> <span class="n">corrected_parquet_available_flag</span><span class="p">,</span>
                                   <span class="n">frs_id_list</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">,</span> <span class="n">sector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Explores process-level emissions reported by the GHGRP database at the unit level.</span>
<span class="sd">    Combines process-level information from supplementary GHGRP files with STEWI data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    naics1, naics2, naics3, naics4 : int or str</span>
<span class="sd">        Various NAICS codes.</span>
<span class="sd">    filename_flag : bool</span>
<span class="sd">        Flag for Flight file availability.</span>
<span class="sd">    naics_list : list</span>
<span class="sd">        List of NAICS codes (if available).</span>
<span class="sd">    corrected_parquet_available_flag : bool</span>
<span class="sd">        Flag indicating if a corrected parquet file is available.</span>
<span class="sd">    frs_id_list : list</span>
<span class="sd">        List of FRS IDs.</span>
<span class="sd">    out_path2 : str</span>
<span class="sd">        Output directory for the sector.</span>
<span class="sd">    sector : str</span>
<span class="sd">        The sector name.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">process_info_ghgrp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;Unit_process_info_GHGRP.csv&quot;</span><span class="p">))</span>
        <span class="n">process_info_ghgrp</span><span class="p">[[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">,</span> <span class="s1">&#39;Industry Type (subparts)&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">process_info_ghgrp</span><span class="p">[[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">,</span> <span class="s1">&#39;Industry Type (subparts)&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">process_info_ghgrp</span> <span class="o">=</span> <span class="n">process_info_ghgrp</span><span class="p">[[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">,</span> <span class="s1">&#39;FRS Id&#39;</span><span class="p">,</span> <span class="s1">&#39;Primary NAICS Code&#39;</span><span class="p">,</span> <span class="s1">&#39;Industry Type (subparts)&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;Industry Type (sectors)&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit Type&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit Reporting Method&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;Unit Maximum Rated Heat Input Capacity (mmBTU/hr)&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit CO2 emissions (non-biogenic) &#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;Unit Methane (CH4) emissions &#39;</span><span class="p">,</span> <span class="s1">&#39;Unit Nitrous Oxide (N2O) emissions &#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;Unit Biogenic CO2 emissions (metric tons)&#39;</span><span class="p">]]</span>

        <span class="n">process_info_ghgrp</span><span class="p">[</span><span class="s1">&#39;FRS Id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">process_info_ghgrp</span><span class="p">[</span><span class="s1">&#39;FRS Id&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
        <span class="n">process_info_ghgrp</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FRS Id&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename_flag</span><span class="p">:</span>
            <span class="n">df1_sector</span> <span class="o">=</span> <span class="n">process_info_ghgrp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">process_info_ghgrp</span><span class="p">[</span><span class="s1">&#39;Primary NAICS Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">naics_list</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df1_sector</span> <span class="o">=</span> <span class="n">process_info_ghgrp</span><span class="p">[(</span><span class="n">process_info_ghgrp</span><span class="p">[</span><span class="s1">&#39;Primary NAICS Code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">naics1</span><span class="p">)</span> <span class="o">|</span>
                                            <span class="p">(</span><span class="n">process_info_ghgrp</span><span class="p">[</span><span class="s1">&#39;Primary NAICS Code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">naics2</span><span class="p">)</span> <span class="o">|</span>
                                            <span class="p">(</span><span class="n">process_info_ghgrp</span><span class="p">[</span><span class="s1">&#39;Primary NAICS Code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">naics3</span><span class="p">)</span> <span class="o">|</span>
                                            <span class="p">(</span><span class="n">process_info_ghgrp</span><span class="p">[</span><span class="s1">&#39;Primary NAICS Code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">naics4</span><span class="p">)]</span>

        <span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;FRS Id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;FRS Id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">ghgrp_process_df</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">corrected_parquet_available_flag</span><span class="p">:</span>
            <span class="n">ghgrp_process_df</span> <span class="o">=</span> <span class="n">ghgrp_process_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ghgrp_process_df</span><span class="p">[</span><span class="s1">&#39;FRS Id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">frs_id_list</span><span class="p">)]</span>

        <span class="n">ghgrp_process_df</span><span class="p">[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ghgrp_process_df</span><span class="p">[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">ghgrp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;facility_GHGRP.csv&quot;</span><span class="p">))</span>
        <span class="n">ghgrp_df</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ghgrp_df</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">ghgrp_process_df</span> <span class="o">=</span> <span class="n">ghgrp_process_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ghgrp_df</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

        <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_inventory_with_process_data_ghgrp_unit_level.csv&quot;</span><span class="p">)</span>
        <span class="n">ghgrp_process_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GHGRP unit-level process data saved to </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in ghgrp_process_exploration_unit: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></div>



<div class="viewcode-block" id="ghgrp_process_exploration_fuel">
<a class="viewcode-back" href="../aegis.html#aegis.ghgrp_process_exploration_fuel">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ghgrp_process_exploration_fuel</span><span class="p">(</span><span class="n">naics1</span><span class="p">,</span> <span class="n">naics2</span><span class="p">,</span> <span class="n">naics3</span><span class="p">,</span> <span class="n">naics4</span><span class="p">,</span>
                                   <span class="n">filename_flag</span><span class="p">,</span> <span class="n">naics_list</span><span class="p">,</span> <span class="n">corrected_parquet_available_flag</span><span class="p">,</span>
                                   <span class="n">frs_id_list</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">,</span> <span class="n">sector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Explores process-level emissions reported by the GHGRP database at the fuel level.</span>
<span class="sd">    Combines process-level information from supplementary GHGRP fuel files with STEWI data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    naics1, naics2, naics3, naics4 : int or str</span>
<span class="sd">        Various NAICS codes.</span>
<span class="sd">    filename_flag : bool</span>
<span class="sd">        Flag for Flight file availability.</span>
<span class="sd">    naics_list : list</span>
<span class="sd">        List of NAICS codes (if available).</span>
<span class="sd">    corrected_parquet_available_flag : bool</span>
<span class="sd">        Flag indicating if a corrected parquet file is available.</span>
<span class="sd">    frs_id_list : list</span>
<span class="sd">        List of FRS IDs.</span>
<span class="sd">    out_path2 : str</span>
<span class="sd">        Output directory for the sector.</span>
<span class="sd">    sector : str</span>
<span class="sd">        The sector name.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">process_info_ghgrp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;Fuel_process_info_GHGRP.csv&quot;</span><span class="p">))</span>
        <span class="n">process_info_ghgrp</span><span class="p">[[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">,</span> <span class="s1">&#39;Industry Type (subparts)&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">process_info_ghgrp</span><span class="p">[[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">,</span> <span class="s1">&#39;Industry Type (subparts)&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">process_info_ghgrp</span> <span class="o">=</span> <span class="n">process_info_ghgrp</span><span class="p">[[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">,</span> <span class="s1">&#39;FRS Id&#39;</span><span class="p">,</span> <span class="s1">&#39;Primary NAICS Code&#39;</span><span class="p">,</span> <span class="s1">&#39;Industry Type (subparts)&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;Industry Type (sectors)&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit Name&#39;</span><span class="p">,</span> <span class="s1">&#39;General Fuel Type&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;Specific Fuel Type&#39;</span><span class="p">,</span> <span class="s1">&#39;Other Fuel Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Blend Fuel Name&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;Fuel Methane (CH4) emissions (mt CO2e)&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;Fuel Nitrous Oxide (N2O) emissions (mt CO2e)&#39;</span><span class="p">]]</span>

        <span class="n">process_info_ghgrp</span><span class="p">[</span><span class="s1">&#39;FRS Id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">process_info_ghgrp</span><span class="p">[</span><span class="s1">&#39;FRS Id&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
        <span class="n">process_info_ghgrp</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FRS Id&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename_flag</span><span class="p">:</span>
            <span class="n">df1_sector</span> <span class="o">=</span> <span class="n">process_info_ghgrp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">process_info_ghgrp</span><span class="p">[</span><span class="s1">&#39;Primary NAICS Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">naics_list</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df1_sector</span> <span class="o">=</span> <span class="n">process_info_ghgrp</span><span class="p">[(</span><span class="n">process_info_ghgrp</span><span class="p">[</span><span class="s1">&#39;Primary NAICS Code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">naics1</span><span class="p">)</span> <span class="o">|</span>
                                            <span class="p">(</span><span class="n">process_info_ghgrp</span><span class="p">[</span><span class="s1">&#39;Primary NAICS Code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">naics2</span><span class="p">)</span> <span class="o">|</span>
                                            <span class="p">(</span><span class="n">process_info_ghgrp</span><span class="p">[</span><span class="s1">&#39;Primary NAICS Code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">naics3</span><span class="p">)</span> <span class="o">|</span>
                                            <span class="p">(</span><span class="n">process_info_ghgrp</span><span class="p">[</span><span class="s1">&#39;Primary NAICS Code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">naics4</span><span class="p">)]</span>

        <span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;FRS Id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="p">[</span><span class="s1">&#39;FRS Id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">ghgrp_process_df</span> <span class="o">=</span> <span class="n">df1_sector</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">corrected_parquet_available_flag</span><span class="p">:</span>
            <span class="n">ghgrp_process_df</span> <span class="o">=</span> <span class="n">ghgrp_process_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ghgrp_process_df</span><span class="p">[</span><span class="s1">&#39;FRS Id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">frs_id_list</span><span class="p">)]</span>

        <span class="n">ghgrp_process_df</span><span class="p">[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ghgrp_process_df</span><span class="p">[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">ghgrp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;facility_GHGRP.csv&quot;</span><span class="p">))</span>
        <span class="n">ghgrp_df</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ghgrp_df</span><span class="p">[[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">ghgrp_process_df</span> <span class="o">=</span> <span class="n">ghgrp_process_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ghgrp_df</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

        <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_inventory_with_process_data_ghgrp_fuel_level.csv&quot;</span><span class="p">)</span>
        <span class="n">ghgrp_process_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GHGRP fuel-level process data saved to </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in ghgrp_process_exploration_fuel: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></div>



<div class="viewcode-block" id="ghgrp">
<a class="viewcode-back" href="../aegis.html#aegis.ghgrp">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ghgrp</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">filename_flag</span><span class="p">,</span> <span class="n">ghgrpfilename</span><span class="p">,</span> <span class="n">out_path3</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">naics1</span><span class="p">,</span> <span class="n">frs_id_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads GHGRP data files, compares them with the facility-level inventory, and creates issue files listing various issues,</span>
<span class="sd">    including missing facilities and FRS mismatches.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    year : int or str</span>
<span class="sd">        Year being analyzed.</span>
<span class="sd">    filename_flag : bool</span>
<span class="sd">        Flag indicating if the GHGRP Flight file is available.</span>
<span class="sd">    ghgrpfilename : str</span>
<span class="sd">        Filename for the GHGRP Flight file.</span>
<span class="sd">    out_path3 : str</span>
<span class="sd">        Path to the issue files directory.</span>
<span class="sd">    out_path2 : str</span>
<span class="sd">        Output directory for the sector.</span>
<span class="sd">    sector : str</span>
<span class="sd">        The sector name.</span>
<span class="sd">    naics1 : int or str</span>
<span class="sd">        Primary NAICS code.</span>
<span class="sd">    frs_id_list : list</span>
<span class="sd">        List of FRS IDs.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        A list of NAICS codes extracted from the GHGRP flight file (if available).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ghgrp_raw_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;GHGRP_epa_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.xlsx&quot;</span><span class="p">))</span>
        <span class="n">ghgrp_raw_data</span> <span class="o">=</span> <span class="n">ghgrp_raw_data</span><span class="p">[[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">,</span> <span class="s1">&#39;FRS Id&#39;</span><span class="p">,</span> <span class="s1">&#39;Facility Name&#39;</span><span class="p">,</span> <span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;Zip Code&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;Address&#39;</span><span class="p">,</span> <span class="s1">&#39;County&#39;</span><span class="p">,</span> <span class="s1">&#39;Latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Primary NAICS Code&#39;</span><span class="p">]]</span>
        <span class="n">ghgrp_raw_data</span><span class="p">[[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">,</span> <span class="s1">&#39;FRS Id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ghgrp_raw_data</span><span class="p">[[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">,</span> <span class="s1">&#39;FRS Id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>

        <span class="n">naics_list_local</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ghgrp_raw_output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;GHGRP_facility_information_file.xlsx&quot;</span><span class="p">)</span>
        <span class="n">ghgrp_raw_data</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">ghgrp_raw_output</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GHGRP raw facility information saved to </span><span class="si">{</span><span class="n">ghgrp_raw_output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename_flag</span><span class="p">:</span>
            <span class="n">df_ghgrp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ghgrpfilename</span><span class="p">)</span>
            <span class="n">df_ghgrp</span><span class="p">[</span><span class="s1">&#39;GHGRP ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ghgrp</span><span class="p">[</span><span class="s1">&#39;GHGRP ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
            <span class="n">df_ghgrp</span> <span class="o">=</span> <span class="n">df_ghgrp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ghgrp_raw_data</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GHGRP ID&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">])</span>
            <span class="n">naics_list_local</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df_ghgrp</span><span class="p">[</span><span class="s1">&#39;Primary NAICS Code&#39;</span><span class="p">]))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracted NAICS list from GHGRP Flight file.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_ghgrp</span> <span class="o">=</span> <span class="n">ghgrp_raw_data</span><span class="p">[</span><span class="n">ghgrp_raw_data</span><span class="p">[</span><span class="s1">&#39;Primary NAICS Code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">naics1</span><span class="p">]</span>

        <span class="n">f_sector_production</span> <span class="o">=</span> <span class="n">df_ghgrp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">df1_f_sector</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_inventory_facility_level.csv&quot;</span><span class="p">))</span>
        <span class="n">df1_f_sector</span> <span class="o">=</span> <span class="n">df1_f_sector</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">df1_f_sector</span> <span class="o">=</span> <span class="n">df1_f_sector</span><span class="p">[[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityName&#39;</span><span class="p">,</span> <span class="s1">&#39;Address&#39;</span><span class="p">,</span> <span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Zip&#39;</span><span class="p">,</span> <span class="s1">&#39;Latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;County&#39;</span><span class="p">,</span> <span class="s1">&#39;NAICS&#39;</span><span class="p">,</span> <span class="s1">&#39;SIC&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">]]</span>
        <span class="n">df1_f_sector</span> <span class="o">=</span> <span class="n">df1_f_sector</span><span class="p">[</span><span class="n">df1_f_sector</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;GHGRP&#39;</span><span class="p">]</span>

        <span class="n">f_sector_production</span> <span class="o">=</span> <span class="n">f_sector_production</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="c1"># Merge GHGRP facility production with the inventory.</span>
        <span class="n">missing_facilities</span> <span class="o">=</span> <span class="n">f_sector_production</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df1_f_sector</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">missing_facilities</span><span class="p">[</span><span class="s1">&#39;FRS_ID_Issues&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">missing_facilities</span><span class="p">[</span><span class="s1">&#39;FRS Id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">missing_facilities</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">],</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">missing_facilities</span> <span class="o">=</span> <span class="n">missing_facilities</span><span class="p">[</span><span class="n">missing_facilities</span><span class="p">[</span><span class="s1">&#39;FRS_ID_Issues&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>

        <span class="n">issues_file_frs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_ghgrp_issue_frs_mismatch.csv&quot;</span><span class="p">)</span>
        <span class="n">missing_facilities</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">issues_file_frs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GHGRP FRS mismatch issues saved to </span><span class="si">{</span><span class="n">issues_file_frs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">missing_facilities</span> <span class="o">=</span> <span class="n">f_sector_production</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df1_f_sector</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">missing_facilities</span> <span class="o">=</span> <span class="n">missing_facilities</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;issues&#39;</span><span class="p">)</span>
        <span class="n">issues_with_ghgrp</span> <span class="o">=</span> <span class="n">missing_facilities</span><span class="p">[(</span><span class="n">missing_facilities</span><span class="p">[</span><span class="s1">&#39;FRS Id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;issues&quot;</span><span class="p">)</span> <span class="o">|</span>
                                               <span class="p">(</span><span class="n">missing_facilities</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NaN&quot;</span><span class="p">)</span> <span class="o">|</span>
                                               <span class="p">(</span><span class="n">missing_facilities</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span> <span class="o">|</span>
                                               <span class="p">(</span><span class="n">missing_facilities</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nan&#39;</span><span class="p">)</span> <span class="o">|</span>
                                               <span class="p">(</span><span class="n">missing_facilities</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">|</span>
                                               <span class="p">(</span><span class="n">missing_facilities</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span>
                                               <span class="p">(</span><span class="n">missing_facilities</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;issues&#39;</span><span class="p">)</span> <span class="o">|</span>
                                               <span class="p">(</span><span class="n">missing_facilities</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;issues&#39;</span><span class="p">)]</span>

        <span class="n">issues_file_missing</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_ghgrp_issue_missing_facility.csv&quot;</span><span class="p">)</span>
        <span class="n">issues_with_ghgrp</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">issues_file_missing</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GHGRP missing facility issues saved to </span><span class="si">{</span><span class="n">issues_file_missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">issues_with_ghgrp</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">issues_with_ghgrp</span><span class="p">[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">]))</span>

        <span class="n">dff1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;flow_by_facility_GHGRP.csv&quot;</span><span class="p">))</span>
        <span class="n">dff3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;combinedinventories_NEI_TRI_GHGRP.csv&quot;</span><span class="p">))</span>

        <span class="n">ghgrp_missing_in_stewi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">ghgrp_missing_in_combination_frs_fac_id_issue</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">ghgrp_missing_other_issues</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">ide</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">df2</span> <span class="o">=</span> <span class="n">dff1</span><span class="p">[</span><span class="n">dff1</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ide</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">df2</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">df2</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ide</span><span class="p">]</span>
                <span class="n">ghgrp_missing_in_stewi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ghgrp_missing_in_stewi</span><span class="p">,</span> <span class="n">df2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df3_temp</span> <span class="o">=</span> <span class="n">dff3</span><span class="p">[</span><span class="n">dff3</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ide</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">df3_temp</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">df3_temp</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ide</span><span class="p">]</span>
                    <span class="n">ghgrp_missing_in_combination_frs_fac_id_issue</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ghgrp_missing_in_combination_frs_fac_id_issue</span><span class="p">,</span> <span class="n">df3_temp</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df4</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ide</span><span class="p">]</span>
                    <span class="n">ghgrp_missing_other_issues</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ghgrp_missing_other_issues</span><span class="p">,</span> <span class="n">df4</span><span class="p">])</span>

        <span class="n">ghgrp_missing_in_stewi</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_ghgrp_missing_in_stewi.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">facility_ghgrp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;facility_GHGRP.csv&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ghgrp_missing_in_combination_frs_fac_id_issue</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">ghgrp_missing_in_combination_frs_fac_id_issue</span> <span class="o">=</span> <span class="n">ghgrp_missing_in_combination_frs_fac_id_issue</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">facility_ghgrp</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Facility Id&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">])</span>
        <span class="n">ghgrp_missing_in_combination_frs_fac_id_issue</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_ghgrp_missing_in_combination_frs_fac_id_issue.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">ghgrp_missing_other_issues</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_ghgrp_missing_other_issues.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">naics_list_local</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in ghgrp: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>



<div class="viewcode-block" id="nei">
<a class="viewcode-back" href="../aegis.html#aegis.nei">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">nei</span><span class="p">(</span><span class="n">naics_list</span><span class="p">,</span> <span class="n">filename_flag</span><span class="p">,</span> <span class="n">naics1</span><span class="p">,</span> <span class="n">naics2</span><span class="p">,</span> <span class="n">naics3</span><span class="p">,</span> <span class="n">naics4</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">,</span> <span class="n">out_path3</span><span class="p">,</span> <span class="n">sector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the NEI data files, compares them with the facility-level inventory, and creates issue files listing various issues,</span>
<span class="sd">    including missing facilities and FRS mismatches.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    naics_list : list</span>
<span class="sd">        List of NAICS codes for the industrial sector.</span>
<span class="sd">    filename_flag : bool</span>
<span class="sd">        Flag indicating if the Flight file is available.</span>
<span class="sd">    naics1, naics2, naics3, naics4 : int or str</span>
<span class="sd">        Various NAICS codes.</span>
<span class="sd">    out_path2 : str</span>
<span class="sd">        Output directory for the sector.</span>
<span class="sd">    out_path3 : str</span>
<span class="sd">        Path to the issue files directory.</span>
<span class="sd">    sector : str</span>
<span class="sd">        The sector name.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">nei_raw_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;NEI_facility_information_file.xlsx&quot;</span><span class="p">))</span>
        <span class="n">nei_raw_data</span><span class="p">[</span><span class="s1">&#39;naics code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nei_raw_data</span><span class="p">[</span><span class="s1">&#39;naics code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">naics_list2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">naics_list</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">filename_flag</span><span class="p">:</span>
            <span class="n">f_sector</span> <span class="o">=</span> <span class="n">nei_raw_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">nei_raw_data</span><span class="p">[</span><span class="s1">&#39;naics code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">naics_list2</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f_sector</span> <span class="o">=</span> <span class="n">nei_raw_data</span><span class="p">[(</span><span class="n">nei_raw_data</span><span class="p">[</span><span class="s1">&#39;naics code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">naics1</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">nei_raw_data</span><span class="p">[</span><span class="s1">&#39;naics code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">naics2</span><span class="p">))</span> <span class="o">|</span>
                                    <span class="p">(</span><span class="n">nei_raw_data</span><span class="p">[</span><span class="s1">&#39;naics code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">naics3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">nei_raw_data</span><span class="p">[</span><span class="s1">&#39;naics code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">naics4</span><span class="p">)]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

        <span class="n">nei_raw_data</span><span class="p">[</span><span class="s1">&#39;naics description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nei_raw_data</span><span class="p">[</span><span class="s1">&#39;naics description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">df1_f_sector</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_inventory_facility_level.csv&quot;</span><span class="p">))</span>
        <span class="n">df1_f_sector</span> <span class="o">=</span> <span class="n">df1_f_sector</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">df1_f_sector</span> <span class="o">=</span> <span class="n">df1_f_sector</span><span class="p">[[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityName&#39;</span><span class="p">,</span> <span class="s1">&#39;Address&#39;</span><span class="p">,</span> <span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Zip&#39;</span><span class="p">,</span> <span class="s1">&#39;Latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;County&#39;</span><span class="p">,</span> <span class="s1">&#39;NAICS&#39;</span><span class="p">,</span> <span class="s1">&#39;SIC&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">df1_f_sector</span> <span class="o">=</span> <span class="n">df1_f_sector</span><span class="p">[</span><span class="n">df1_f_sector</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NEI&quot;</span><span class="p">]</span>

        <span class="n">f_sector</span><span class="p">[</span><span class="s1">&#39;eis facility id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_sector</span><span class="p">[</span><span class="s1">&#39;eis facility id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">f_sector</span> <span class="o">=</span> <span class="n">f_sector</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

        <span class="n">issues_with_nei_r</span> <span class="o">=</span> <span class="n">f_sector</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df1_f_sector</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;eis facility id&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span>
        <span class="n">issues_with_nei_r</span> <span class="o">=</span> <span class="n">issues_with_nei_r</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;issues&#39;</span><span class="p">)</span>
        <span class="n">issues_with_nei</span> <span class="o">=</span> <span class="n">issues_with_nei_r</span><span class="p">[(</span><span class="n">issues_with_nei_r</span><span class="p">[</span><span class="s1">&#39;eis facility id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;issues&quot;</span><span class="p">)</span> <span class="o">|</span>
                                            <span class="p">(</span><span class="n">issues_with_nei_r</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NaN&quot;</span><span class="p">)</span> <span class="o">|</span>
                                            <span class="p">(</span><span class="n">issues_with_nei_r</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span> <span class="o">|</span>
                                            <span class="p">(</span><span class="n">issues_with_nei_r</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nan&#39;</span><span class="p">)</span> <span class="o">|</span>
                                            <span class="p">(</span><span class="n">issues_with_nei_r</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">|</span>
                                            <span class="p">(</span><span class="n">issues_with_nei_r</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span>
                                            <span class="p">(</span><span class="n">issues_with_nei_r</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;issues&#39;</span><span class="p">)</span> <span class="o">|</span>
                                            <span class="p">(</span><span class="n">issues_with_nei_r</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;issues&#39;</span><span class="p">)]</span>

        <span class="n">missing_facilities2</span> <span class="o">=</span> <span class="n">issues_with_nei</span><span class="p">[[</span><span class="s1">&#39;eis facility id&#39;</span><span class="p">,</span> <span class="s1">&#39;site name&#39;</span><span class="p">,</span> <span class="s1">&#39;FRS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityName&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">missing_facilities_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_nei_issue_missing_facility_using_naics_codes.csv&quot;</span><span class="p">)</span>
        <span class="n">missing_facilities2</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">missing_facilities_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NEI missing facility issues saved to </span><span class="si">{</span><span class="n">missing_facilities_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">missing_facilities2</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;eis facility id&#39;</span><span class="p">]))</span>

        <span class="n">dff1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;flow_by_facility_NEI.csv&quot;</span><span class="p">))</span>
        <span class="n">dff3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;combinedinventories_NEI_TRI_GHGRP.csv&quot;</span><span class="p">))</span>

        <span class="n">nei_missing_in_stewi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">nei_missing_in_combination_frs_fac_id_issue</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">nei_missing_other_issues</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">ide</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">df2</span> <span class="o">=</span> <span class="n">dff1</span><span class="p">[</span><span class="n">dff1</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ide</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">df2</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">df2</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;eis facility id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ide</span><span class="p">]</span>
                <span class="n">nei_missing_in_stewi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">nei_missing_in_stewi</span><span class="p">,</span> <span class="n">df2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df3_temp</span> <span class="o">=</span> <span class="n">dff3</span><span class="p">[</span><span class="n">dff3</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ide</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">df3_temp</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">df3_temp</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;eis facility id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ide</span><span class="p">]</span>
                    <span class="n">nei_missing_in_combination_frs_fac_id_issue</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">nei_missing_in_combination_frs_fac_id_issue</span><span class="p">,</span> <span class="n">df3_temp</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df4</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;eis facility id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ide</span><span class="p">]</span>
                    <span class="n">nei_missing_other_issues</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">nei_missing_other_issues</span><span class="p">,</span> <span class="n">df4</span><span class="p">])</span>

        <span class="n">nei_missing_in_stewi</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_nei_missing_in_stewi.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">facility_nei</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;facility_NEI.csv&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nei_missing_in_combination_frs_fac_id_issue</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">nei_missing_in_combination_frs_fac_id_issue</span> <span class="o">=</span> <span class="n">nei_missing_in_combination_frs_fac_id_issue</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">facility_nei</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;eis facility id&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">])</span>
        <span class="n">nei_missing_in_combination_frs_fac_id_issue</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_nei_missing_in_combination_frs_fac_id_issue.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">nei_missing_other_issues</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_nei_missing_other_issues.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in nei: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></div>



<div class="viewcode-block" id="tri">
<a class="viewcode-back" href="../aegis.html#aegis.tri">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">tri</span><span class="p">(</span><span class="n">naics_list</span><span class="p">,</span> <span class="n">frs_id_list</span><span class="p">,</span> <span class="n">filename_flag</span><span class="p">,</span> <span class="n">naics1</span><span class="p">,</span> <span class="n">naics2</span><span class="p">,</span> <span class="n">naics3</span><span class="p">,</span> <span class="n">naics4</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">,</span> <span class="n">out_path3</span><span class="p">,</span> <span class="n">sector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads TRI data files, compares them with the facility-level inventory, and creates issue files listing various issues,</span>
<span class="sd">    including missing facilities and FRS mismatches.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    naics_list : list</span>
<span class="sd">        List of NAICS codes for the industrial sector.</span>
<span class="sd">    filename_flag : bool</span>
<span class="sd">        Flag indicating if the Flight file is available.</span>
<span class="sd">    naics1, naics2, naics3, naics4 : int or str</span>
<span class="sd">        Various NAICS codes.</span>
<span class="sd">    out_path2 : str</span>
<span class="sd">        Output directory for the sector.</span>
<span class="sd">    out_path3 : str</span>
<span class="sd">        Path to the issue files directory.</span>
<span class="sd">    sector : str</span>
<span class="sd">        The sector name.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tri_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;TRI_Facility_information_file.xlsx&quot;</span><span class="p">))</span>
        <span class="n">tri_data</span><span class="p">[</span><span class="s1">&#39;PRIMARY NAICS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tri_data</span><span class="p">[</span><span class="s1">&#39;PRIMARY NAICS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">naics_list2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">naics_list</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">filename_flag</span><span class="p">:</span>
            <span class="n">f_sector1</span> <span class="o">=</span> <span class="n">tri_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tri_data</span><span class="p">[</span><span class="s1">&#39;PRIMARY NAICS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">naics_list2</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f_sector1</span> <span class="o">=</span> <span class="n">tri_data</span><span class="p">[(</span><span class="n">tri_data</span><span class="p">[</span><span class="s1">&#39;PRIMARY NAICS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">naics1</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">tri_data</span><span class="p">[</span><span class="s1">&#39;PRIMARY NAICS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">naics2</span><span class="p">))</span> <span class="o">|</span>
                                <span class="p">(</span><span class="n">tri_data</span><span class="p">[</span><span class="s1">&#39;PRIMARY NAICS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">naics3</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">tri_data</span><span class="p">[</span><span class="s1">&#39;PRIMARY NAICS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">naics4</span><span class="p">))]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

        <span class="n">df1_f_sector</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_inventory_facility_level.csv&quot;</span><span class="p">))</span>
        <span class="n">df1_f_sector</span> <span class="o">=</span> <span class="n">df1_f_sector</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">df1_f_sector</span> <span class="o">=</span> <span class="n">df1_f_sector</span><span class="p">[[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityName&#39;</span><span class="p">,</span> <span class="s1">&#39;Address&#39;</span><span class="p">,</span> <span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Zip&#39;</span><span class="p">,</span> <span class="s1">&#39;Latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;County&#39;</span><span class="p">,</span> <span class="s1">&#39;NAICS&#39;</span><span class="p">,</span> <span class="s1">&#39;SIC&#39;</span><span class="p">,</span> <span class="s1">&#39;FacilityID&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">df1_f_sector</span> <span class="o">=</span> <span class="n">df1_f_sector</span><span class="p">[</span><span class="n">df1_f_sector</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TRI&quot;</span><span class="p">]</span>
        <span class="n">df1_f_sector</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1_f_sector</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">f_sector1</span><span class="p">[</span><span class="s1">&#39;TRIFD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_sector1</span><span class="p">[</span><span class="s1">&#39;TRIFD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>

        <span class="n">issues_with_tri_r</span> <span class="o">=</span> <span class="n">f_sector1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df1_f_sector</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;TRIFD&quot;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;FacilityID&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span> <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">issues_with_tri_r</span> <span class="o">=</span> <span class="n">issues_with_tri_r</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;issues&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">issues_with_tri</span> <span class="o">=</span> <span class="n">issues_with_tri_r</span><span class="p">[(</span><span class="n">issues_with_tri_r</span><span class="p">[</span><span class="s1">&#39;TRIFD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;issues&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">issues_with_tri_r</span><span class="p">[</span><span class="s1">&#39;FACILITY NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;issues&quot;</span><span class="p">)</span> <span class="o">|</span>
                                            <span class="p">(</span><span class="n">issues_with_tri_r</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NaN&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">issues_with_tri_r</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span> <span class="o">|</span>
                                            <span class="p">(</span><span class="n">issues_with_tri_r</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nan&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">issues_with_tri_r</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">|</span>
                                            <span class="p">(</span><span class="n">issues_with_tri_r</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">issues_with_tri_r</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;issues&#39;</span><span class="p">)</span> <span class="o">|</span>
                                            <span class="p">(</span><span class="n">issues_with_tri_r</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;issues&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">issues_with_tri_r</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;issues&#39;</span><span class="p">)]</span>

        <span class="n">issues_file_tri</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_tri_issue_missing_facility_all_using_naics_code.csv&quot;</span><span class="p">)</span>
        <span class="n">issues_with_tri</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">issues_file_tri</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TRI missing facility issues saved to </span><span class="si">{</span><span class="n">issues_file_tri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename_flag</span><span class="p">:</span>
            <span class="n">issues_with_tri_ghgrp_only</span> <span class="o">=</span> <span class="n">issues_with_tri</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">issues_with_tri</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">frs_id_list</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">issues_with_tri_ghgrp_only</span> <span class="o">=</span> <span class="n">issues_with_tri</span>

        <span class="n">issues_with_tri_frs_issues</span> <span class="o">=</span> <span class="n">issues_with_tri_ghgrp_only</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">issues_with_tri_frs_issues</span><span class="p">[</span><span class="s1">&#39;FRS_ID_Issues&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">issues_with_tri_frs_issues</span><span class="p">[</span><span class="s1">&#39;FRS ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">issues_with_tri_frs_issues</span><span class="p">[</span><span class="s1">&#39;FRS_ID&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">issues_with_tri_frs_issues</span> <span class="o">=</span> <span class="n">issues_with_tri_frs_issues</span><span class="p">[</span><span class="n">issues_with_tri_frs_issues</span><span class="p">[</span><span class="s1">&#39;FRS_ID_Issues&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>

        <span class="n">issues_file_tri_frs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_tri_issue_frs_mismatch.csv&quot;</span><span class="p">)</span>
        <span class="n">issues_with_tri_frs_issues</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">issues_file_tri_frs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TRI FRS mismatch issues saved to </span><span class="si">{</span><span class="n">issues_file_tri_frs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">issues_with_tri</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;TRIFD&#39;</span><span class="p">]))</span>
        <span class="n">dff1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;flow_by_facility_TRI.csv&quot;</span><span class="p">))</span>
        <span class="n">dff3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;combinedinventories_NEI_TRI_GHGRP.csv&quot;</span><span class="p">))</span>

        <span class="n">tri_missing_in_stewi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">tri_missing_in_combination_frs_fac_id_issue</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">tri_missing_other_issues</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">ide</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">df2</span> <span class="o">=</span> <span class="n">dff1</span><span class="p">[</span><span class="n">dff1</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ide</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">df2</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">df2</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;TRIFD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ide</span><span class="p">]</span>
                <span class="n">tri_missing_in_stewi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tri_missing_in_stewi</span><span class="p">,</span> <span class="n">df2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df3_temp</span> <span class="o">=</span> <span class="n">dff3</span><span class="p">[</span><span class="n">dff3</span><span class="p">[</span><span class="s1">&#39;FacilityID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ide</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">df3_temp</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">df3_temp</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;TRIFD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ide</span><span class="p">]</span>
                    <span class="n">tri_missing_in_combination_frs_fac_id_issue</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tri_missing_in_combination_frs_fac_id_issue</span><span class="p">,</span> <span class="n">df3_temp</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df4</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;TRIFD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ide</span><span class="p">]</span>
                    <span class="n">tri_missing_other_issues</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tri_missing_other_issues</span><span class="p">,</span> <span class="n">df4</span><span class="p">])</span>

        <span class="n">issues_file_tri_ghgrp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_tri_issue_missing_facility_ghgrp_only.csv&quot;</span><span class="p">)</span>
        <span class="n">issues_with_tri_ghgrp_only</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">issues_file_tri_ghgrp</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TRI missing facility (GHGRP only) issues saved to </span><span class="si">{</span><span class="n">issues_file_tri_ghgrp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">tri_missing_in_stewi</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_tri_missing_in_stewi.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">tri_missing_in_combination_frs_fac_id_issue</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_tri_missing_in_combination_frs_fac_id_issue.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">tri_missing_other_issues</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">_tri_missing_other_issues.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in tri: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></div>

   



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../aegis.html#aegis.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">sector</span><span class="p">,</span> <span class="n">filename_flag</span><span class="p">,</span> <span class="n">naics</span><span class="p">,</span> <span class="n">corrected_parquet_available_flag</span><span class="p">,</span> <span class="n">flag_for_running_stewi</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overarching function to compile the emissions inventories.</span>

<span class="sd">    This function is called by the run file to create the FECM inventory. It:</span>
<span class="sd">      1. Retrieves data using STEWI.</span>
<span class="sd">      2. Compiles facility and process-level inventories.</span>
<span class="sd">      3. Produces issue files and stack parameter information files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sector : str</span>
<span class="sd">        Industrial sector being analyzed.</span>
<span class="sd">    filename_flag : bool</span>
<span class="sd">        Flag indicating if the GHGRP Flight file is present.</span>
<span class="sd">    naics : int or str</span>
<span class="sd">        NAICS code for the sector.</span>
<span class="sd">    corrected_parquet_available_flag : bool</span>
<span class="sd">        Flag indicating if a corrected STEWI parquet file is available.</span>
<span class="sd">    flag_for_running_stewi : bool</span>
<span class="sd">        Flag to determine whether to run the STEWI process.</span>
<span class="sd">    year : int or str</span>
<span class="sd">        Year being analyzed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">option</span> <span class="o">=</span> <span class="s2">&quot;GHGRP Not Preferred&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;cement&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="s2">&quot;flight_cement.xls&quot;</span><span class="p">,</span> <span class="s1">&#39;co2concentration&#39;</span><span class="p">:</span> <span class="mf">0.3183</span><span class="p">},</span>
        <span class="s1">&#39;steel&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="s2">&quot;flight_steel.xls&quot;</span><span class="p">,</span> <span class="s1">&#39;co2concentration&#39;</span><span class="p">:</span> <span class="mf">0.3515</span><span class="p">},</span>
        <span class="s1">&#39;ethanol&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="s2">&quot;flight_ethanol.xls&quot;</span><span class="p">,</span> <span class="s1">&#39;co2concentration&#39;</span><span class="p">:</span> <span class="mf">0.999999</span><span class="p">},</span>
        <span class="s1">&#39;ammonia&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="s2">&quot;flight_ammonia.xls&quot;</span><span class="p">,</span> <span class="s1">&#39;co2concentration&#39;</span><span class="p">:</span> <span class="mf">0.987887169</span><span class="p">},</span>
        <span class="s1">&#39;hydrogen&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="s2">&quot;flight_hydrogen.xls&quot;</span><span class="p">,</span> <span class="s1">&#39;co2concentration&#39;</span><span class="p">:</span> <span class="mf">0.999999</span><span class="p">},</span>
        <span class="s1">&#39;pulp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="s2">&quot;flight_pulp.xls&quot;</span><span class="p">,</span> <span class="s1">&#39;co2concentration&#39;</span><span class="p">:</span> <span class="mf">0.9999999</span><span class="p">},</span>
        <span class="s1">&#39;refining&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="s2">&quot;flight_refining.xls&quot;</span><span class="p">,</span> <span class="s1">&#39;co2concentration&#39;</span><span class="p">:</span> <span class="mf">0.9999999</span><span class="p">},</span>
        <span class="s1">&#39;natural_gas_processing&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="s2">&quot;flight_natural_gas_processing_agr.xlsx&quot;</span><span class="p">,</span> <span class="s1">&#39;co2concentration&#39;</span><span class="p">:</span> <span class="mf">0.995884774</span><span class="p">},</span>
    <span class="p">}</span>
    
    <span class="c1"># Create output subdirectories for the sector and issue files.</span>
    <span class="n">out_path2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path1</span><span class="p">,</span> <span class="n">sector</span><span class="p">)</span>
    <span class="n">out_path3</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="s2">&quot;issue_files&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_path2</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_path3</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created subdirectories: </span><span class="si">{</span><span class="n">out_path2</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">out_path3</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating subdirectories: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># NAICS codes for sectors when codes are not available from the FLIGHT Tool.</span>
    <span class="n">naics1</span> <span class="o">=</span> <span class="n">naics</span>
    <span class="n">naics2</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">naics3</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">naics4</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    
    <span class="c1"># Filename for reading GHGRP data from the FLIGHT Tool.</span>
    <span class="n">ghgrpfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sector</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">flag_for_running_stewi</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running STEWI process as flagged.&quot;</span><span class="p">)</span>
        <span class="n">run_stewi</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">out_path3</span><span class="p">)</span>
    
    <span class="n">df1_sector</span><span class="p">,</span> <span class="n">naics_list</span><span class="p">,</span> <span class="n">frs_id_list</span> <span class="o">=</span> <span class="n">manipulate_databases</span><span class="p">(</span>
        <span class="n">naics1</span><span class="p">,</span> <span class="n">naics2</span><span class="p">,</span> <span class="n">naics3</span><span class="p">,</span> <span class="n">naics4</span><span class="p">,</span>
        <span class="n">filename_flag</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">corrected_parquet_available_flag</span><span class="p">,</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">ghgrpfilename</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">,</span> <span class="n">out_path3</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">co2concentration</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">sector</span><span class="p">][</span><span class="s1">&#39;co2concentration&#39;</span><span class="p">]</span>
        <span class="n">facility_stack_parameters</span><span class="p">(</span><span class="n">df1_sector</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">)</span>
        <span class="n">overlap_explorer</span><span class="p">(</span><span class="n">df1_sector</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">out_path3</span><span class="p">)</span>
        <span class="n">sector_df2</span> <span class="o">=</span> <span class="n">emission_concentration_calculation</span><span class="p">(</span><span class="n">df1_sector</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">)</span>
        <span class="n">plots_and_exploration1</span><span class="p">(</span><span class="n">sector_df2</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">)</span>
        <span class="n">sector_df3</span> <span class="o">=</span> <span class="n">concentration_calculation</span><span class="p">(</span><span class="n">sector_df2</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">,</span> <span class="n">co2concentration</span><span class="p">)</span>
        <span class="n">plots_and_exploration2</span><span class="p">(</span><span class="n">sector_df3</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">)</span>
        <span class="c1"># ghgrp returns a NAICS list extracted from the GHGRP Flight file (if available)</span>
        <span class="n">naics_list_local</span> <span class="o">=</span> <span class="n">ghgrp</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">filename_flag</span><span class="p">,</span> <span class="n">ghgrpfilename</span><span class="p">,</span> <span class="n">out_path3</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">naics1</span><span class="p">,</span> <span class="n">frs_id_list</span><span class="p">)</span>
        <span class="n">tri</span><span class="p">(</span><span class="n">naics_list_local</span><span class="p">,</span> <span class="n">frs_id_list</span><span class="p">,</span> <span class="n">filename_flag</span><span class="p">,</span> <span class="n">naics1</span><span class="p">,</span> <span class="n">naics2</span><span class="p">,</span> <span class="n">naics3</span><span class="p">,</span> <span class="n">naics4</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">,</span> <span class="n">out_path3</span><span class="p">,</span> <span class="n">sector</span><span class="p">)</span>
        <span class="n">nei</span><span class="p">(</span><span class="n">naics_list_local</span><span class="p">,</span> <span class="n">filename_flag</span><span class="p">,</span> <span class="n">naics1</span><span class="p">,</span> <span class="n">naics2</span><span class="p">,</span> <span class="n">naics3</span><span class="p">,</span> <span class="n">naics4</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">,</span> <span class="n">out_path3</span><span class="p">,</span> <span class="n">sector</span><span class="p">)</span>
        <span class="n">nei_by_process_exploration</span><span class="p">(</span><span class="n">naics1</span><span class="p">,</span> <span class="n">naics2</span><span class="p">,</span> <span class="n">naics3</span><span class="p">,</span> <span class="n">naics4</span><span class="p">,</span> <span class="n">filename_flag</span><span class="p">,</span> <span class="n">naics_list_local</span><span class="p">,</span>
                                     <span class="n">corrected_parquet_available_flag</span><span class="p">,</span> <span class="n">frs_id_list</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">,</span> <span class="n">sector</span><span class="p">)</span>
        <span class="n">ghgrp_process_exploration_unit</span><span class="p">(</span><span class="n">naics1</span><span class="p">,</span> <span class="n">naics2</span><span class="p">,</span> <span class="n">naics3</span><span class="p">,</span> <span class="n">naics4</span><span class="p">,</span> <span class="n">filename_flag</span><span class="p">,</span> <span class="n">naics_list_local</span><span class="p">,</span>
                                       <span class="n">corrected_parquet_available_flag</span><span class="p">,</span> <span class="n">frs_id_list</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">,</span> <span class="n">sector</span><span class="p">)</span>
        <span class="n">ghgrp_process_exploration_fuel</span><span class="p">(</span><span class="n">naics1</span><span class="p">,</span> <span class="n">naics2</span><span class="p">,</span> <span class="n">naics3</span><span class="p">,</span> <span class="n">naics4</span><span class="p">,</span> <span class="n">filename_flag</span><span class="p">,</span> <span class="n">naics_list_local</span><span class="p">,</span>
                                       <span class="n">corrected_parquet_available_flag</span><span class="p">,</span> <span class="n">frs_id_list</span><span class="p">,</span> <span class="n">out_path2</span><span class="p">,</span> <span class="n">sector</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error during NEI/TRI/GHGRP explorations: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Tapajyoti Ghosh.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>